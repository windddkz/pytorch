name: Lite PyTorch Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'aten/**'
      - 'torch/**'
      - '.github/workflows/lite-pytorch.yml'

jobs:
  build-cpu-only:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      USE_CUDA: 0
      USE_CUDNN: 0
      USE_ROCM: 0
      USE_DISTRIBUTED: 0
      USE_MKLDNN: 0
      USE_FBGEMM: 0
      USE_NNPACK: 0
      USE_QNNPACK: 0
      USE_XNNPACK: 0
      BUILD_TEST: 0
      BUILD_CAFFE2: 0
      CMAKE_BUILD_TYPE: Release
      MAX_JOBS: 2

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build ccache cmake
          pip install -r requirements.txt
          pip install ninja pyyaml typing_extensions

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-pytorch-cpu

      - name: Build PyTorch (Lite)
        run: |
          echo "Building with MAX_JOBS=$MAX_JOBS"
          python setup.py develop

      - name: Quick Sanity Check
        run: |
          python -c "import torch; print('PyTorch Version:', torch.__version__); print('CUDA Available:', torch.cuda.is_available()); x = torch.tensor([1, 2]); print(x + x)"
